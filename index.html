<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CBP Operations Dashboard - Enhanced v2</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            line-height: 1.6;
        }

        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding: 1.5rem;
            text-align: center;
            color: white;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 0.8rem;
            letter-spacing: -0.02em;
        }

        .status-bar {
            display: flex;
            justify-content: center;
            gap: 2.5rem;
            margin-top: 0.8rem;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 0.7rem;
            font-size: 0.95rem;
            font-weight: 500;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4CAF50;
            box-shadow: 0 0 8px rgba(76, 175, 80, 0.6);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2.5rem;
        }

        .controls {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2.5rem;
            box-shadow: 0 10px 40px rgba(31, 38, 135, 0.37);
            backdrop-filter: blur(8px);
        }

        .controls h3 {
            margin-bottom: 1.5rem;
            color: #2c3e50;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.7rem;
        }

        .control-group label {
            font-weight: 600;
            color: #555;
            font-size: 0.9rem;
        }

        select, button {
            padding: 1rem;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        select:focus, button:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15);
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            position: relative;
            overflow: hidden;
        }

        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        button:hover::before {
            left: 100%;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2.5rem;
            margin-bottom: 2.5rem;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 40px rgba(31, 38, 135, 0.37);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .card h3 {
            margin-bottom: 1.5rem;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 0.7rem;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        /* Schedule Styles */
        .schedule-filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.7rem 1.2rem;
            border: 2px solid #e1e8ed;
            background: white;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .filter-btn:hover:not(.active) {
            border-color: #667eea;
            color: #667eea;
        }

        .route-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.2rem;
            max-height: 550px;
            overflow-y: auto;
            padding-right: 0.5rem;
        }

        .route-grid::-webkit-scrollbar {
            width: 6px;
        }

        .route-grid::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .route-grid::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }

        .route-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            padding: 1.3rem;
            border-left: 5px solid #28a745;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .route-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 50%);
            pointer-events: none;
        }

        .route-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .route-card.inbound {
            border-left-color: #007bff;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        }

        .route-card.outbound {
            border-left-color: #28a745;
            background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
        }

        .route-time {
            font-size: 1.4rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 0.7rem;
        }

        .route-details {
            font-size: 0.95rem;
            color: #666;
            margin-bottom: 0.6rem;
        }

        .route-direction {
            font-size: 0.85rem;
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            display: inline-block;
            font-weight: 600;
            margin-top: 0.5rem;
        }

        .inbound-tag {
            background: rgba(33, 150, 243, 0.15);
            color: #1976d2;
            border: 1px solid rgba(33, 150, 243, 0.3);
        }

        .outbound-tag {
            background: rgba(76, 175, 80, 0.15);
            color: #388e3c;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        /* Weather Styles */
        .weather-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.2rem;
            max-height: 500px;
            overflow-y: auto;
        }

        .weather-location {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-radius: 15px;
            padding: 1.5rem;
            border: 1px solid rgba(33, 150, 243, 0.2);
        }

        .weather-location h4 {
            margin-bottom: 1rem;
            color: #1565c0;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .weather-current {
            background: rgba(255, 255, 255, 0.7);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .current-display {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }

        .weather-icon {
            font-size: 2rem;
        }

        .current-temp {
            font-size: 1.8rem;
            font-weight: bold;
            color: #1565c0;
        }

        .current-desc {
            color: #666;
            font-size: 0.9rem;
            margin-left: 3rem;
        }

        .forecast-header {
            font-size: 0.9rem;
            font-weight: 600;
            color: #1565c0;
            margin-bottom: 0.7rem;
        }

        .hourly-forecast {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.7rem;
        }

        .forecast-hour {
            text-align: center;
            padding: 0.8rem 0.5rem;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 10px;
            font-size: 0.8rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }

        .forecast-hour:hover {
            background: rgba(255, 255, 255, 0.9);
            transform: translateY(-2px);
        }

        .forecast-time {
            font-weight: 600;
            color: #1565c0;
            margin-bottom: 0.3rem;
        }

        .forecast-icon {
            font-size: 1.2rem;
            margin: 0.3rem 0;
        }

        .forecast-temp {
            font-weight: 600;
            color: #333;
        }

        /* Traffic Styles */
        .traffic-sections {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .traffic-section {
            padding: 1.5rem;
            border-radius: 15px;
            border: 2px solid transparent;
        }

        .inbound-section {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-color: #2196f3;
        }

        .outbound-section {
            background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
            border-color: #4caf50;
        }

        .traffic-section h4 {
            margin-bottom: 1.2rem;
            text-align: center;
            font-size: 1.2rem;
            color: #2c3e50;
            font-weight: 600;
        }

        .corridor-item {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.8rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .corridor-item:hover {
            background: rgba(255, 255, 255, 0.95);
            transform: translateX(3px);
        }

        .corridor-info {
            flex: 1;
        }

        .corridor-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.3rem;
        }

        .corridor-details {
            font-size: 0.8rem;
            color: #666;
        }

        .corridor-speed {
            font-size: 0.9rem;
            padding: 0.4rem 0.8rem;
            border-radius: 15px;
            font-weight: 600;
            min-width: 80px;
            text-align: center;
        }

        .speed-smooth { 
            background: linear-gradient(135deg, #d4edda, #c3e6cb); 
            color: #155724; 
            border: 1px solid #b8e6c1;
        }
        .speed-moderate { 
            background: linear-gradient(135deg, #fff3cd, #ffeaa7); 
            color: #856404; 
            border: 1px solid #f9e79f;
        }
        .speed-heavy { 
            background: linear-gradient(135deg, #f8d7da, #f5b7b1); 
            color: #721c24; 
            border: 1px solid #f1948a;
        }
        .speed-jam { 
            background: linear-gradient(135deg, #dc3545, #c82333); 
            color: white; 
            border: 1px solid #bd2130;
        }

        /* Alerts */
        .alerts-container {
            margin-bottom: 1rem;
        }

        .alert {
            padding: 1.2rem;
            border-radius: 12px;
            margin-bottom: 0.8rem;
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            transition: all 0.3s ease;
        }

        .alert:hover {
            transform: translateX(3px);
        }

        .alert-icon {
            font-size: 1.2rem;
            margin-top: 0.2rem;
        }

        .alert-content {
            flex: 1;
        }

        .alert-message {
            font-weight: 500;
            margin-bottom: 0.3rem;
        }

        .alert-time {
            font-size: 0.8rem;
            opacity: 0.7;
        }

        .alert-high { 
            background: linear-gradient(135deg, #f8d7da, #f5b7b1); 
            border-left: 4px solid #dc3545; 
            color: #721c24;
        }
        .alert-medium { 
            background: linear-gradient(135deg, #fff3cd, #ffeaa7); 
            border-left: 4px solid #ffc107; 
            color: #856404;
        }
        .alert-low { 
            background: linear-gradient(135deg, #d4edda, #c3e6cb); 
            border-left: 4px solid #28a745; 
            color: #155724;
        }

        /* Loading States */
        .loading {
            text-align: center;
            padding: 3rem;
            color: #666;
        }

        .spinner {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .traffic-sections {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 1.5rem;
            }
            
            .control-grid {
                grid-template-columns: 1fr;
            }
            
            .route-grid {
                grid-template-columns: 1fr;
            }
            
            .weather-grid {
                grid-template-columns: 1fr;
            }
            
            .hourly-forecast {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .status-bar {
                flex-direction: column;
                gap: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🚌 CBP Operations Dashboard</h1>
        <div class="status-bar">
            <div class="status-item">
                <div class="status-dot"></div>
                <span>System Online</span>
            </div>
            <div class="status-item">
                <div class="status-dot"></div>
                <span>Real-time Data</span>
            </div>
            <div class="status-item">
                <div class="status-dot"></div>
                <span>All Services Active</span>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Controls Section -->
        <div class="controls">
            <h3>📊 Monitoring Controls</h3>
            <div class="control-grid">
                <div class="control-group">
                    <label>Time Priority</label>
                    <select id="timePriority">
                        <option value="auto">Auto (Current Time)</option>
                        <option value="morning">Morning Rush</option>
                        <option value="evening">Evening Rush</option>
                        <option value="all">All Day</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Route Filter</label>
                    <select id="routeFilter">
                        <option value="all">All Routes</option>
                        <option value="inbound">Inbound (To CBP)</option>
                        <option value="outbound">Outbound (From CBP)</option>
                        <option value="express">Express Routes</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Update Frequency</label>
                    <select id="updateFreq">
                        <option value="300000">5 Minutes</option>
                        <option value="120000">2 Minutes</option>
                        <option value="60000">1 Minute</option>
                        <option value="30000">30 Seconds</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Actions</label>
                    <button onclick="refreshAllData()">🔄 Refresh Data</button>
                </div>
            </div>
        </div>

        <!-- Dashboard Grid -->
        <div class="dashboard-grid">
            <!-- Active Schedule -->
            <div class="card full-width">
                <h3>🕐 Complete Schedule Overview</h3>
                <div class="schedule-filters">
                    <button class="filter-btn active" data-filter="all">All Routes</button>
                    <button class="filter-btn" data-filter="inbound">To CBP</button>
                    <button class="filter-btn" data-filter="outbound">From CBP</button>
                    <button class="filter-btn" data-filter="morning">Morning</button>
                    <button class="filter-btn" data-filter="evening">Evening</button>
                </div>
                <div id="scheduleContent" class="route-grid">
                    <div class="loading">
                        <div class="spinner"></div>
                        Loading complete schedule data...
                    </div>
                </div>
            </div>

            <!-- Weather Impact -->
            <div class="card">
                <h3>🌤️ Weather Overview</h3>
                <div id="weatherContent" class="weather-grid">
                    <div class="loading">
                        <div class="spinner"></div>
                        Fetching weather data...
                    </div>
                </div>
            </div>

            <!-- Traffic Intelligence -->
            <div class="card">
                <h3>🚗 Traffic Intelligence</h3>
                <div id="trafficContent" class="traffic-sections">
                    <div class="loading">
                        <div class="spinner"></div>
                        Analyzing traffic patterns...
                    </div>
                </div>
            </div>
        </div>

        <!-- Smart Alerts -->
        <div class="card">
            <h3>🚨 Smart Alerts</h3>
            <div id="alertsContent" class="alerts-container">
                <div class="loading">
                    <div class="spinner"></div>
                    Loading alert systems...
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = 'https://cbp-ops-api.o-shanneng.workers.dev';
        let updateInterval;
        let allRoutes = [];
        let currentFilter = 'all';

        // Initialize Dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
            refreshAllData();
            setupAutoUpdate();
        });

        function initializeEventListeners() {
            // Schedule filters
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentFilter = this.dataset.filter;
                    filterAndDisplayRoutes();
                });
            });

            // Control changes
            document.getElementById('updateFreq').addEventListener('change', function() {
                setupAutoUpdate();
            });

            document.getElementById('routeFilter').addEventListener('change', function() {
                currentFilter = this.value;
                filterAndDisplayRoutes();
            });
        }

        function setupAutoUpdate() {
            if (updateInterval) clearInterval(updateInterval);
            const frequency = parseInt(document.getElementById('updateFreq').value);
            updateInterval = setInterval(refreshAllData, frequency);
        }

        async function refreshAllData() {
            console.log('🔄 Refreshing all data...');
            
            // Update status dots to loading
            document.querySelectorAll('.status-dot').forEach(dot => {
                dot.style.background = '#ffc107';
                dot.style.boxShadow = '0 0 8px rgba(255, 193, 7, 0.6)';
            });

            try {
                await Promise.all([
                    loadCompleteSchedule(),
                    loadWeatherForecast(),
                    loadTrafficIntelligence(),
                    loadSmartAlerts()
                ]);
                
                // Success - green dots
                document.querySelectorAll('.status-dot').forEach(dot => {
                    dot.style.background = '#28a745';
                    dot.style.boxShadow = '0 0 8px rgba(40, 167, 69, 0.6)';
                });
            } catch (error) {
                console.error('Error refreshing data:', error);
                // Error - red dots
                document.querySelectorAll('.status-dot').forEach(dot => {
                    dot.style.background = '#dc3545';
                    dot.style.boxShadow = '0 0 8px rgba(220, 53, 69, 0.6)';
                });
            }
        }

        async function loadCompleteSchedule() {
            try {
                const response = await fetch(`${API_BASE}/schedule`);
                const data = await response.json();
                
                if (data.routes && Array.isArray(data.routes)) {
                    allRoutes = data.routes;
                    filterAndDisplayRoutes();
                } else {
                    throw new Error('Invalid schedule data format');
                }
            } catch (error) {
                console.error('Error loading schedule:', error);
                document.getElementById('scheduleContent').innerHTML = 
                    '<div class="loading">❌ Failed to load schedule data</div>';
            }
        }

        function filterAndDisplayRoutes() {
            let filteredRoutes = allRoutes;

            // Apply filters
            switch (currentFilter) {
                case 'inbound':
                    filteredRoutes = allRoutes.filter(r => r.direction === 'inbound');
                    break;
                case 'outbound':
                    filteredRoutes = allRoutes.filter(r => r.direction === 'outbound');
                    break;
                case 'morning':
                    filteredRoutes = allRoutes.filter(r => {
                        const hour = parseInt(r.time.split(':')[0]);
                        return hour >= 7 && hour <= 10;
                    });
                    break;
                case 'evening':
                    filteredRoutes = allRoutes.filter(r => {
                        const hour = parseInt(r.time.split(':')[0]);
                        return hour >= 17 && hour <= 20;
                    });
                    break;
                default:
                    // Show all routes
                    break;
            }

            displayRoutes(filteredRoutes);
        }

        function displayRoutes(routes) {
            const container = document.getElementById('scheduleContent');
            
            if (!routes || routes.length === 0) {
                container.innerHTML = '<div class="loading">📭 No routes match the current filter</div>';
                return;
            }

            const routeCards = routes.map(route => {
                const directionClass = route.direction === 'inbound' ? 'inbound' : 'outbound';
                const directionTag = route.direction === 'inbound' ? 'inbound-tag' : 'outbound-tag';
                const directionText = route.direction === 'inbound' ? '➡️ To CBP' : '⬅️ From CBP';
                
                return `
                    <div class="route-card ${directionClass}">
                        <div class="route-time">${route.time}</div>
                        <div class="route-details"><strong>${route.name}</strong></div>
                        <div class="route-details">
                            <strong>Corridor:</strong> ${route.corridor || 'N/A'}
                        </div>
                        <div class="route-details">
                            <strong>ETA:</strong> ${route.etaToCbpMin || 0} minutes
                        </div>
                        <span class="route-direction ${directionTag}">${directionText}</span>
                    </div>
                `;
            }).join('');

            container.innerHTML = routeCards;
        }

        async function loadWeatherForecast() {
            try {
                const response = await fetch(`${API_BASE}/forecast/locations`);
                const data = await response.json();
                
                if (data.locations) {
                    displayWeatherForecast(data.locations);
                } else {
                    throw new Error('Invalid weather data format');
                }
            } catch (error) {
                console.error('Error loading weather:', error);
                document.getElementById('weatherContent').innerHTML = 
                    '<div class="loading">❌ Failed to load weather data</div>';
            }
        }

        function displayWeatherForecast(locations) {
            const container = document.getElementById('weatherContent');
            
            const weatherCards = Object.entries(locations).map(([key, location]) => {
                const current = location.current || {};
                const hourly = location.hourly || [];
                
                // Get forecasts for 2-hour blocks: +2h, +4h, +6h, +8h
                const twoHourForecasts = [];
                const now = new Date();
                
                // Find forecasts closest to 2, 4, 6, 8 hours from now
                for (let hours of [2, 4, 6, 8]) {
                    const targetTime = new Date(now.getTime() + (hours * 60 * 60 * 1000));
                    
                    // Find the forecast closest to this target time
                    let closestForecast = null;
                    let minDiff = Infinity;
                    
                    for (const forecast of hourly) {
                        if (forecast.time) {
                            const forecastTime = new Date(forecast.time);
                            const diff = Math.abs(forecastTime.getTime() - targetTime.getTime());
                            if (diff < minDiff) {
                                minDiff = diff;
                                closestForecast = { ...forecast, targetHours: hours };
                            }
                        }
                    }
                    
                    if (closestForecast) {
                        twoHourForecasts.push(closestForecast);
                    }
                }
                
                // Format the 2-hour block forecasts
                const hourlyForecasts = twoHourForecasts.map(hour => {
                    return `
                        <div class="forecast-hour">
                            <div class="forecast-time">+${hour.targetHours}h</div>
                            <div class="forecast-icon">${hour.icon || '🌤️'}</div>
                            <div class="forecast-temp">${hour.temp || 0}°C</div>
                        </div>
                    `;
                }).join('');
                
                return `
                    <div class="weather-location">
                        <h4>${location.name || key}</h4>
                        
                        <div class="weather-current">
                            <div class="current-display">
                                <span class="weather-icon">${current.icon || '🌤️'}</span>
                                <span class="current-temp">${current.temp || 0}°C</span>
                            </div>
                            <div class="current-desc">${current.description || 'Current conditions'}</div>
                        </div>
                        
                        <div class="forecast-header">Next 8 Hours (2-hour blocks)</div>
                        <div class="hourly-forecast">
                            ${hourlyForecasts || '<div style="grid-column: 1/-1; text-align: center; color: #666;">No forecast data</div>'}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = weatherCards || '<div class="loading">📭 No weather data available</div>';
        }

        async function loadTrafficIntelligence() {
            try {
                const response = await fetch(`${API_BASE}/traffic/corridors`);
                const data = await response.json();
                
                if (data.corridors) {
                    displayTrafficIntelligence(data.corridors);
                } else {
                    throw new Error('Invalid traffic data format');
                }
            } catch (error) {
                console.error('Error loading traffic:', error);
                document.getElementById('trafficContent').innerHTML = 
                    '<div class="loading">❌ Failed to load traffic data</div>';
            }
        }

        function displayTrafficIntelligence(corridors) {
            const container = document.getElementById('trafficContent');
            
            // Separate corridors based on their names (correct logic)
            const inboundCorridors = [];
            const outboundCorridors = [];
            
            Object.entries(corridors).forEach(([name, corridor]) => {
                if (name.includes('(To CBP)')) {
                    inboundCorridors.push({ name, ...corridor });
                } else if (name.includes('(From CBP)')) {
                    outboundCorridors.push({ name, ...corridor });
                }
            });
            
            function createCorridorHTML(corridorList, title, sectionClass) {
                const corridorItems = corridorList.map(corridor => {
                    const speedClass = getSpeedClass(corridor.speed);
                    const cleanName = corridor.name.replace(' (To CBP)', '').replace(' (From CBP)', '');
                    
                    return `
                        <div class="corridor-item">
                            <div class="corridor-info">
                                <div class="corridor-name">${cleanName}</div>
                                <div class="corridor-details">
                                    ${corridor.expressway} • ${corridor.description || 'Traffic conditions'}
                                </div>
                            </div>
                            <div class="corridor-speed ${speedClass}">
                                ${corridor.speed || 0} km/h
                            </div>
                        </div>
                    `;
                }).join('');
                
                return `
                    <div class="traffic-section ${sectionClass}">
                        <h4>${title}</h4>
                        ${corridorItems || '<div style="text-align: center; color: #666; padding: 1rem;">No data available</div>'}
                    </div>
                `;
            }
            
            container.innerHTML = 
                createCorridorHTML(inboundCorridors, '➡️ To CBP (Inbound)', 'inbound-section') +
                createCorridorHTML(outboundCorridors, '⬅️ From CBP (Outbound)', 'outbound-section');
        }

        function getSpeedClass(speed) {
            if (speed < 20) return 'speed-jam';
            if (speed < 35) return 'speed-heavy';
            if (speed < 50) return 'speed-moderate';
            return 'speed-smooth';
        }

        async function loadSmartAlerts() {
            try {
                const response = await fetch(`${API_BASE}/alerts`);
                const alerts = await response.json();
                
                if (Array.isArray(alerts)) {
                    displaySmartAlerts(alerts);
                } else {
                    throw new Error('Invalid alerts data format');
                }
            } catch (error) {
                console.error('Error loading alerts:', error);
                document.getElementById('alertsContent').innerHTML = 
                    '<div class="loading">❌ Failed to load alerts</div>';
            }
        }

        function displaySmartAlerts(alerts) {
            const container = document.getElementById('alertsContent');
            
            if (!alerts || alerts.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-low">
                        <span class="alert-icon">✅</span>
                        <div class="alert-content">
                            <div class="alert-message">All systems operating normally</div>
                            <div class="alert-time">No active alerts</div>
                        </div>
                    </div>
                `;
                return;
            }
            
            const alertItems = alerts.map(alert => {
                const alertClass = `alert-${alert.priority || 'low'}`;
                const icon = alert.priority === 'high' ? '🚨' : 
                           alert.priority === 'medium' ? '⚠️' : 'ℹ️';
                
                return `
                    <div class="alert ${alertClass}">
                        <span class="alert-icon">${icon}</span>
                        <div class="alert-content">
                            <div class="alert-message">
                                <strong>${alert.type || 'System'}:</strong> ${alert.message}
                            </div>
                            <div class="alert-time">
                                ${new Date(alert.time).toLocaleString('en-SG')}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = alertItems;
        }

        // Global refresh function
        window.refreshAllData = refreshAllData;
    </script>
</body>
</html>